<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Coding</title>


</head>

<body>
    <div id='container'>

        <br id='container_end'></div>
    </div>
</body>
<script>

    function postMsg(line, character) {
        const vscode = acquireVsCodeApi();
        vscode.postMessage({ line, character });
    }

    // Handle the message inside the webview


    window.addEventListener('message', event => {
        const message = event.data; // The JSON data our extension sent
        initial(message); // initialize data, rebuild code structure
    });

    /** 
     * functions for handle content in code block
     */
    var codeAnalysis = {
        /**
         * Split source to sub code block's source text
         * @function
         * @prarm {string} t source text from editor.
         * @retruns {object} sub code block's source text
         */
        block: function (t) {
            var _result = []; // result for CodeBlock array;


            let _t = t;
            let _fxNameStReg = /(?<=function)/; // key for function start
            let _fxNameEdReg = /{/; // key for function name end
            let _regResult = reg.list(t, /(?<=function).*?(?={)/);
                for (let i = 0; i < _regResult.result.length; i++) {
                    const element = _regResult.result[i];
                    _result.push(new CodeBlock())
                    
                }
            


        },
        /**
        * for seperate lines in vsc source. will get lines index array.
        * @param {string} t source text.
        * @returns {array} array for line objects.
        */
        line: function (t){

        },

        anno: function (b) { },
        prop: function (b) { },
    }

    /**
     * Initial whole process
     * @function
     */
    function initial(content) {

        let container = document.getElementById('container');
        let container_ed = document.getElementById('container_end');

        // analysis contetn text and generate a content node tree;
        let sourceTree = contentStructure(content);

        //render node tree;
        diagramRender(sourceTree, container);

        //when click on each element rendered on container, move cursor to where it is.
        eventHandler.do_vscCursor();
        // event include these:
        // 1: mouse :   cilck on diagram move cursor to the position
        // 2: zoom:     select and zoom in.
        // 3: modify:   change diagram content (add/delete/modify)update to vscode
        // 4: gesture:  move or drag update to vscode

    }


    /**
     * generate code block instances
     * @function
     * @param {string} content text capture from editor. 
     * @returns {CodeBlock} root CodeBlock instance.
     */
    function contentStructure(content) {
        let _result = content; // : string

        _result = codeAnalysis.block(_result); // return root block
        

        return _result;// root block include all block instances
    }



    /**
     * Create codeBlock instance for block structure, which contain line, charater, 
     * content, etc...
     * @class
     * @param {string} name function name;
     * @param {number} index index in vsc
     * @param {string} source source content.
     * @param {CodeBlock} next next CodeBlock node
     * @param {CodeBlock} previous previous CodeBlock node
     */
    function CodeBlock(name, index, source) {
        this.name = name;
        this.line = line;
        this.character = character;
        this.content = source;
        this.previous = null;
        this.next = null;

    }


    function blockTraversal(rootNode, ...f) {
        //... here will be rootNode childrens Traversal
        f.forEach(i => {
            i(rootNode);
        });
        // ... end of child Traversal
    }


    function diagramRender(nodeTree, container) {
        let _nodeT = nodeTree;
        if (nodeTree == null) {
            throw ('code structure is empty');
            return;
        }
        // PositionGenerator(nodeTree); // add position prop to block

        /** 
         * Render source
         * @param {string} content innerText of render element.
        */
        function renderElementGenerator(content) {
            var _result = document.createElement('div');
            _result.innerText = content;
            container.appendChild(_result);
            return _result;
        }

        nodeTree.forEach(i => {
            renderElementGenerator(i);
        });
        // do {
        //     container.appendChild(renderElementGenerator(_nodeT.head));
        //     _nodeT = _nodeT.next;
        // }while(_nodeT.next!=false);

    }


    var eventHandler = {
        do_vscCursor: function (param) { }
    };
    /* ||||||||||||||||||||||||||||||||||| Text handle functions||||||||||||||||||||||||||||||||||||*/
    /**
     * Text handler
     * @function
     * RegExp extension
     */
    var reg = {
    /**
    * search regExp in whole string, will return a list for all information
    * @param {string} source source input text
    * @param {RegExp} k searching keyword.
    * @retrun {[]} list for all information in sourceText.
    */
        list: function (source, k){
            let _key = new RegExp(k,'g');
            //Attention: Here must be 'g' as attr, otherwise only output first result;
            
            let _s = source;
            let _result = {result:[],groups:[],index:[],input:[],length:[]};
            let _item = _key.exec(_s);
            while(_item != null ){
 
                _result.result.push(_item[0])
                _result.groups.push(_item.groups);
                _result.index.push(_item.index);
                _result.input.push(_item.input);
                _result.length.push(_item.length);

  
                // _result.push(_item);
                _item = _key.exec(_s);
            }
            return _result;
        }

    }


        console.log(reg.list('asdasdasd','s'));

    initial(`
    function one(){
        asd
    }
    function two () {
        asd
    }
    HiBitch();
    
    `);
</script>

</html>